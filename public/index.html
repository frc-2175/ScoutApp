<!DOCTYPE html>
<html>
<!-- TODO - Fix autoLoGoal not being pushed to DB -->

<head>
	<title>ScoutApp</title>
	<meta name="theme-color" content=hsl(0, 0%, 15%) />
	<link rel="stylesheet" href="toasting.css" />
	<script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
	<script src="toasting.js"></script>
	<script src="drawing.js"></script>
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-title" />

	<script type="module" src="main.js"></script>
	<script type="module">
		// Import the functions you need from the SDKs you need
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
		import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";
		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries

		// Your web app's Firebase configuration
		const firebaseConfig = {
			apiKey: "AIzaSyCZaXFdEf3DJaOp5C3m1qp_LZ2RhW5_vBA",
			authDomain: "scout-b39c0.firebaseapp.com",
			databaseURL: "https://scout-b39c0-default-rtdb.firebaseio.com",
			projectId: "scout-b39c0",
			storageBucket: "scout-b39c0.appspot.com",
			messagingSenderId: "709936631965",
			appId: "1:709936631965:web:f5de22c8eb8fc69f354474"
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);

		function writeMatchData(matchNumber, teamNumber, teleHiGoal, teleLoGoal, autoHiGoal, autoLoGoal, taxi, notes, event, climb) {

			const db = getDatabase();
			set(ref(db, `${event}/teams/${teamNumber}/${matchNumber}`), {
				matchNumber: matchNumber,
				teamNumber: teamNumber,
				teleop: {
					teleHiGoal,
					teleLoGoal,
					climb
				},
				auto: {
					autoHiGoal,
					autoLoGoal,
					taxi: taxi
				},
				notes: notes
			},
			);
		}

		/* eslint-disable no-unused-vars */
		const key = "Q8VmErPZQKVkOGqbT76NUCU4FhIurBBNVNhWRvRi2dAce33qRWxnCeMvFJntmFcY";

		function getValue(id) {
			return parseInt(document.getElementById(id).value) || 0;
		}

		function setValue(id, value) {
			document.getElementById(id).value = value;
		}

		function increment(id) {
			setValue(id, getValue(id) + 1);
		}

		function decrement(id) {
			setValue(id, Math.max(getValue(id) - 1, 0));
		}

		function clearFields() {
			const idList = ["matchNumber", "teamNumber", "autoHiGoal", "autoLoGoal", "teleHiGoal", "teleLoGoal"]
			idList.forEach((item) => {
				setValue(item, "")
			})
		}

		function disableTouchScroll() {
			let canvas_dom = document.getElementById("defaultCanvas0");
			canvas_dom.addEventListener("touchstart", function (event) { event.preventDefault() })
			canvas_dom.addEventListener("touchmove", function (event) { event.preventDefault() })
			canvas_dom.addEventListener("touchend", function (event) { event.preventDefault() })
			canvas_dom.addEventListener("touchcancel", function (event) { event.preventDefault() })
		}

		function verifyMatchData() {
			let errList = [];
			if (getValue("matchNumber") == "") {
				errList.push("No match number set")
			}
			if (getValue("teamNumber") == "") {
				errList.push("No team number set")
			}
			if (isNaN(parseInt(getValue("teamNumber")))) {
				errList.push("Team number is NaN")
			}
			if (0 > parseInt(getValue("teamNumber")) || parseInt(getValue("teamNumber")) > 9999) {
				errList.push("Team number too large/small")
			}
			if (document.getElementById("eventDropdown").value == "select-event") {
				errList.push("No event selected")
			}
			return errList;
		}

		async function getTeam() {
			const url = "https://www.thebluealliance.com/api/v3/team/frc" + getValue("teamNumber");
			let teamName = await fetch(url, { headers: { "X-TBA-Auth-Key": key } })
				.then((response) => response.json())
				.then((team) => team.nickname);

			teamName = teamName === undefined ? "No team with that number :(" : teamName;

			document.getElementById("teamName").innerText = teamName;

			const eventDropdown = document.getElementById("eventDropdown");

			const eventOptions = document.querySelectorAll('.eventOption');

			eventOptions.forEach(event => {
				event.remove();
			});

			(await getEvents()).forEach((item) => {
				let newOption = document.createElement("option")
				newOption.innerHTML = item.name;
				newOption.value = item.key;
				newOption.classList.add("eventOption");
				eventDropdown.appendChild(newOption);
			})
		}

		async function getEvents() {
			const url = "https://www.thebluealliance.com/api/v3/team/frc" + (getValue("teamNumber") || 2175) + "/events/simple";
			let currentEvents = await (await fetch(url, { headers: { "X-TBA-Auth-Key": key } })).json()

			return [currentEvents[currentEvents.length - 1], currentEvents[currentEvents.length - 2], currentEvents[currentEvents.length - 3], { "name": "Test Event", "key": "test" }];
		}

		function exportData() {
			const match = getValue("matchNumber");
			const team = getValue("teamNumber");
			const teleHi = getValue("teleHiGoal");
			const teleLo = getValue("teleLoGoal");
			const autoHi = getValue("autoHiGoal");
			const autoLo = getValue("autoLoGoal");
			const event = document.getElementById("eventDropdown").value;
			const taxi = document.getElementById("taxi").checked;
			const notes = document.getElementById("notes").value;
			const climb = document.getElementById("climb").value

			let submitError = null;
			let verifyErrs = verifyMatchData();

			if (0 < verifyErrs.length) {
				toasting.create({
					"title": "Error!",
					"text": `Error(s) in data, check team and match number and try again. (${JSON.stringify(verifyErrs)})`,
					"timeout": 5000,
				});
			}
			else {
				try {
					writeMatchData(match, team, teleHi, teleLo, autoHi, autoLo, taxi, notes, event, climb);
				}
				catch (e) {
					submitError = e;
					console.error(e);
				}
				finally {
					if (submitError !== null) {
						toasting.create({
							"title": "Error!",
							"text": `Error posting data to DB: "${submitError}"`,
							"timeout": 5000,
						});
					}
					else {
						toasting.create({
							"title": "Success!",
							"text": "Posted data to DB successfully.",
							"timeout": 5000,
						});
						clearFields();
					}
				}
			}
		}

		function dataURLtoBlob(dataurl) {
			var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
				bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
			while (n--) {
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new Blob([u8arr], { type: mime });
		}
		window.getTeam = getTeam;
		window.exportData = exportData;
		window.increment = increment;
		window.decrement = decrement;
		window.verifyMatchData = verifyMatchData;
		window.getValue = getValue;
		window.getEvents = getEvents;
		window.disableTouchScroll = disableTouchScroll;
		window.dataURLtoBlob = dataURLtoBlob;
	</script>
	<link rel="stylesheet" href="style.css">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>

<body>
	<div class="wrapper">
		<div class="matchInfo">
			<div>
				<h2 style="display: inline;">Match Number: </h2>
				<input id="matchNumber" type="tel" placeholder="0">
			</div>
			<div>
				<h2 style="display: inline;">Team Number: </h2>
				<input id="teamNumber" type="tel" placeholder="0" onchange="getTeam()">
				<h3 id="teamName"></h3>
			</div>
			<div>
				<h2 style="display: inline;">Event Name: </h2>
				<select id="eventDropdown" class="green">
					<option value="select-event">Select an event...</option>
				</select>
				<h3 id="eventName"></h3>
			</div>
		</div>
		<hr width="100%">
		<div class="auto">
			<h1>Auto</h1>
			<div class="taxi">
				<input type="checkbox" id="taxi">
				<label for="taxi">Taxi?</label>
			</div>
			<div>
				<h3>High Goal</h3>
				<button class="button-3d red" onclick="decrement('autoHiGoal')">-</button>
				<input id="autoHiGoal" type="tel" placeholder="0" min="0">
				<button class="button-3d green" onclick="increment('autoHiGoal')">+</button>
			</div>
			<div>
				<h3>Low Goal</h3>
				<button class="button-3d red" onclick="decrement('autoLoGoal')">-</button>
				<input id="autoLoGoal" type="tel" placeholder="0" min="0">
				<button class="button-3d green" onclick="increment('autoLoGoal')">+</button>
			</div>
			<h3>Auto Path</h3>
			<h4>Trace the path that the robot takes during auto. (Draw nothing if no auto)</h4>
			<div id="autoPathParent">
				<div id="autoPath"></div>
			</div>
			<button class="button-3d red" onclick="setup()">Reset</button>
		</div>
		<hr width="100%">
		<div class="teleop">
			<h1>Teleop</h1>
			<div>
				<h3>High Goal</h3>
				<button class="button-3d red" onclick="decrement('teleHiGoal')">-</button>
				<input id="teleHiGoal" type="tel" placeholder="0" min="0">
				<button class="button-3d green" onclick="increment('teleHiGoal')">+</button>
			</div>
			<div>
				<h3>Low Goal</h3>
				<button class="button-3d red" onclick="decrement('teleLoGoal')">-</button>
				<input id="teleLoGoal" type="tel" placeholder="0" min="0">
				<button class="button-3d green" onclick="increment('teleLoGoal')">+</button>
			</div>
			<div>
				<h3>Missed</h3>
				<button class="button-3d red" onclick="decrement('teleMissed')">-</button>
				<input id="teleMissed" type="tel" placeholder="0" min="0">
				<button class="button-3d green" onclick="increment('teleMissed')">+</button>
			</div>
			<div>
				<input type="checkbox" id="malfunc">
				<label for="malfunc">Malfunctioned?</label>
			</div>
			<div>
				<input type="checkbox" id="defense">
				<label for="defense">Played defense?</label>
			</div>
			<div>
				<input type="checkbox" id="defended">
				<label for="defended">Defended against?</label>
			</div>
		</div>
		<hr width="100%">
		<div class="Climb">
			<h1>Climb</h1>
			<div>
				<select id="climb" class="white">
					<option value=0>None</option>
					<option value=4>Low</option>
					<option value=6>Mid</option>
					<option value=10>High</option>
					<option value=15>Traversal</option>
				</select>
			</div>
			<div>
				<input type="checkbox" id="success">
				<label for="success">Succeeded?</label>
			</div>
			<div>
				<h2 style="display: inline;">Start: </h2>
				<input class="white" id="climbStart" type="text" placeholder="2:00">
			</div>
			<div>
				<h2 style="display: inline;">End: </h2>
				<input class="white" id="climbEnd" type="text" placeholder="2:30">
			</div>
		</div>
		<hr width="100%">
		<div class="Notes">
			<h1>Notes</h1>
			<div>
				<textarea id="notes" cols="0" rows="5" placeholder="Write notes here..."></textarea>
			</div>
		</div>
		<br>
		<div>
			<button class="button-3d sky wide" onclick="exportData()">Export!</button>
		</div>
		<div>
			<button class="button-3d green wide" onclick="{window.location = `viewer`}">View Data &#10145;</button>
		</div>
	</div>
</body>

</html>